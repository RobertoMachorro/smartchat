<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>{{ .InstanceName }} - Chat</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<style>
		body {
			background: linear-gradient(120deg, #f8fafc, #fdf2f8);
		}
		.chat-shell {
			height: calc(100vh - 32px);
		}
		.chat-list {
			max-height: calc(100vh - 140px);
			overflow-y: auto;
		}
		.message-area {
			max-height: calc(100vh - 260px);
			overflow-y: auto;
			padding-right: 8px;
		}
		.bubble {
			padding: 12px 14px;
			border-radius: 16px;
			margin-bottom: 12px;
			max-width: 75%;
			white-space: pre-wrap;
		}
		.bubble.user {
			background: #dbeafe;
			margin-left: auto;
			border-bottom-right-radius: 4px;
		}
		.bubble.assistant {
			background: #fff7ed;
			margin-right: auto;
			border-bottom-left-radius: 4px;
		}
		.bubble-meta {
			font-size: 0.75rem;
			color: #6c757d;
		}
		.token-usage {
			font-size: 0.75rem;
			color: #6c757d;
		}
	</style>
</head>
<body>
	<div class="container-fluid py-3">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div>
				<strong>{{ .InstanceName }}</strong>
				<span class="text-muted ms-2">{{ .UserEmail }}</span>
			</div>
			<a class="btn btn-sm btn-outline-secondary" href="/logout">Logout</a>
		</div>
		<div class="row g-3 chat-shell">
			<div class="col-12 col-lg-3">
				<div class="card h-100">
					<div class="card-header">Chats</div>
					<div class="card-body chat-list">
						{{ if .Chats }}
							<div class="list-group list-group-flush">
								{{ range .Chats }}
									<a class="list-group-item list-group-item-action {{ if eq $.Chat.Summary.ID .ID }}active{{ end }}" href="/chat/{{ .ID }}">
										<div class="fw-semibold">{{ .Title }}</div>
										<small class="text-muted" data-utc="{{ formatUTC .UpdatedAt }}">{{ .UpdatedAt }}</small>
									</a>
								{{ end }}
							</div>
						{{ else }}
							<p class="text-muted">No chats yet.</p>
						{{ end }}
					</div>
				</div>
			</div>
			<div class="col-12 col-lg-9">
				<div class="card h-100">
					<div class="card-body d-flex flex-column">
						<div id="messageArea" class="message-area mb-3">
							{{ if .Chat.Messages }}
								{{ range .Chat.Messages }}
									<div class="bubble {{ if eq .Role "user" }}user{{ else }}assistant{{ end }}">
										<div>{{ .Content }}</div>
										<div class="bubble-meta mt-1" data-utc="{{ formatUTC .CreatedAt }}">{{ .CreatedAt }}</div>
									</div>
								{{ end }}
							{{ else }}
								<p class="text-muted">Start the conversation below.</p>
							{{ end }}
						</div>
						<form id="messageForm" method="post" action="/chat/{{ .Chat.Summary.ID }}/message">
							<div class="mb-2">
								<textarea class="form-control" name="content" rows="3" placeholder="Ask something..."></textarea>
							</div>
							<div class="d-flex justify-content-between align-items-center">
								<small id="tokenUsage" class="token-usage">Tokens: --</small>
								<button type="submit" class="btn btn-primary">Send</button>
							</div>
						</form>
						<form id="preferencesForm" class="mt-3" method="post" action="/api/preferences">
							<div class="row g-2 align-items-end">
								<div class="col-12 col-md-5">
									<label class="form-label">Model</label>
									<select class="form-select" name="model" id="modelSelect">
										{{ range .Models }}
											<option value="{{ . }}" {{ if eq $.Model . }}selected{{ end }}>{{ . }}</option>
										{{ end }}
									</select>
								</div>
								<div class="col-12 col-md-5">
									<label class="form-label">Temperature: <span id="tempValue">{{ printf "%.1f" .Temperature }}</span></label>
									<input class="form-range" type="range" min="0.1" max="1.0" step="0.1" name="temperature" id="tempRange" value="{{ printf "%.1f" .Temperature }}">
								</div>
								<div class="col-12 col-md-2">
									<button type="submit" class="btn btn-outline-secondary w-100">Save</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		const messageArea = document.getElementById("messageArea");
		const messageForm = document.getElementById("messageForm");
		const tokenUsage = document.getElementById("tokenUsage");
		const modelSelect = document.getElementById("modelSelect");
		const tempRange = document.getElementById("tempRange");
		const tempValue = document.getElementById("tempValue");
		const preferencesForm = document.getElementById("preferencesForm");

		function appendMessage(message) {
			const bubble = document.createElement("div");
			bubble.className = "bubble " + (message.role === "user" ? "user" : "assistant");
			const content = document.createElement("div");
			content.textContent = message.content;
			const meta = document.createElement("div");
			meta.className = "bubble-meta mt-1";
			meta.dataset.utc = message.createdAt;
			bubble.appendChild(content);
			bubble.appendChild(meta);
			messageArea.appendChild(bubble);
			updateLocalTimes();
			messageArea.scrollTop = messageArea.scrollHeight;
		}

		messageForm.addEventListener("submit", async (event) => {
			event.preventDefault();
			const formData = new FormData(messageForm);
			const content = formData.get("content");
			if (!content || !content.trim()) {
				return;
			}
			messageForm.querySelector("textarea").value = "";
			const response = await fetch("/api/chat/{{ .Chat.Summary.ID }}/message", {
				method: "POST",
				headers: { "Content-Type": "application/json", "Accept": "application/json" },
				body: JSON.stringify({ content: content })
			});
			if (!response.ok) {
				return;
			}
			const payload = await response.json();
			appendMessage(payload.user);
			appendMessage(payload.assistant);
			if (payload.usage) {
				tokenUsage.textContent = `Tokens: ${payload.usage.prompt_tokens} prompt / ${payload.usage.completion_tokens} completion / ${payload.usage.total_tokens} total`;
			}
		});

		tempRange.addEventListener("input", () => {
			tempValue.textContent = parseFloat(tempRange.value).toFixed(1);
		});

		preferencesForm.addEventListener("submit", async (event) => {
			event.preventDefault();
			const body = {
				model: modelSelect.value,
				temperature: tempRange.value
			};
			const response = await fetch("/api/preferences", {
				method: "POST",
				headers: { "Content-Type": "application/json", "Accept": "application/json" },
				body: JSON.stringify(body)
			});
			if (!response.ok) {
				return;
			}
		});

		messageArea.scrollTop = messageArea.scrollHeight;
	</script>
	{{ template "local_time.html" . }}
</body>
</html>
