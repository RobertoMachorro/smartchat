<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>{{ .InstanceName }} - Chat</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<style>
		body {
			background: linear-gradient(120deg, #f8fafc, #fdf2f8);
		}
		.chat-shell {
			height: calc(100vh - 32px);
		}
		.chat-list {
			max-height: calc(100vh - 140px);
			overflow-y: auto;
		}
		.message-area {
			max-height: calc(100vh - 260px);
			overflow-y: auto;
			padding-right: 8px;
		}
		.bubble {
			padding: 12px 14px;
			border-radius: 16px;
			margin-bottom: 12px;
			max-width: 75%;
			white-space: pre-wrap;
		}
		.bubble.user {
			background: #dbeafe;
			margin-left: auto;
			border-bottom-right-radius: 4px;
		}
		.bubble.assistant {
			background: #fff7ed;
			margin-right: auto;
			border-bottom-left-radius: 4px;
		}
		.bubble-meta {
			font-size: 0.75rem;
			color: #6c757d;
		}
		.token-usage {
			font-size: 0.75rem;
			color: #6c757d;
		}
	</style>
</head>
<body>
	<div class="container-fluid py-3">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div>
				<strong>{{ .InstanceName }}</strong>
				<span class="text-muted ms-2">{{ .UserEmail }}</span>
			</div>
			<a class="btn btn-sm btn-outline-secondary" href="/logout">Logout</a>
		</div>
		<div class="row g-3 chat-shell">
			<div class="col-12 col-lg-3">
				<div class="card h-100">
					<div class="card-header d-flex justify-content-between align-items-center">
						<span>Chats</span>
						<form method="post" action="/chat/new" class="m-0">
							<button type="submit" class="btn btn-sm btn-outline-secondary" aria-label="New chat">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 1.5a.5.5 0 0 1 .5.5v5.5H14a.5.5 0 0 1 0 1H8.5V14a.5.5 0 0 1-1 0V8.5H2a.5.5 0 0 1 0-1h5.5V2a.5.5 0 0 1 .5-.5z"/>
								</svg>
							</button>
						</form>
					</div>
					<div class="card-body chat-list">
						{{ if .Chats }}
							<div class="list-group list-group-flush">
								{{ range .Chats }}
									<div class="list-group-item position-relative {{ if eq $.Chat.Summary.ID .ID }}active{{ end }}">
										<div class="d-flex justify-content-between align-items-start">
											<div>
												<a class="stretched-link text-decoration-none {{ if eq $.Chat.Summary.ID .ID }}text-white{{ else }}text-body{{ end }}" href="/chat/{{ .ID }}">
													<div class="fw-semibold">{{ .Title }}</div>
													<small class="{{ if eq $.Chat.Summary.ID .ID }}text-white-50{{ else }}text-muted{{ end }}" data-utc="{{ formatUTC .UpdatedAt }}">{{ .UpdatedAt }}</small>
												</a>
											</div>
											<form method="post" action="/chat/{{ .ID }}/delete" class="ms-2 position-relative z-1" onsubmit="return confirm('Delete this chat?');">
												<button type="submit" class="btn btn-sm btn-outline-danger" aria-label="Delete chat">
													<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
														<path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm2.5.5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0v-6zm3 .5a.5.5 0 0 1-1 0v6a.5.5 0 0 1 1 0v-6z"/>
														<path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5.5l1-1h3l1 1H14a1 1 0 0 1 .5 1zM4 4v9a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4H4z"/>
													</svg>
												</button>
											</form>
										</div>
									</div>
								{{ end }}
							</div>
						{{ else }}
							<p class="text-muted">No chats yet.</p>
						{{ end }}
					</div>
				</div>
			</div>
			<div class="col-12 col-lg-9">
				<div class="card h-100">
					<div class="card-body d-flex flex-column">
						<div id="messageArea" class="message-area mb-3">
							{{ if .Chat.Messages }}
								{{ range .Chat.Messages }}
									<div class="bubble {{ if eq .Role "user" }}user{{ else }}assistant{{ end }}">
										<div>{{ .Content }}</div>
										<div class="bubble-meta mt-1" data-utc="{{ formatUTC .CreatedAt }}">{{ .CreatedAt }}</div>
									</div>
								{{ end }}
							{{ else }}
								<p class="text-muted">Start the conversation below.</p>
							{{ end }}
						</div>
						<form id="messageForm" method="post" action="/chat/{{ .Chat.Summary.ID }}/message">
							<div class="mb-2">
								<textarea class="form-control" name="content" rows="3" placeholder="Ask something..."></textarea>
							</div>
							<div class="row g-2 align-items-end mb-2">
								<div class="col-12 col-md-5">
									<label class="form-label">Model</label>
									<select class="form-select" name="model" id="modelSelect">
										{{ range .Models }}
											<option value="{{ . }}" {{ if eq $.Model . }}selected{{ end }}>{{ . }}</option>
										{{ end }}
									</select>
								</div>
								<div class="col-12 col-md-5">
									<label class="form-label">Temperature: <span id="tempValue">{{ printf "%.1f" .Temperature }}</span></label>
									<input class="form-range" type="range" min="0.1" max="1.0" step="0.1" name="temperature" id="tempRange" value="{{ printf "%.1f" .Temperature }}">
								</div>
							</div>
							<div class="d-flex justify-content-between align-items-center">
								<small id="tokenUsage" class="token-usage">Tokens: --</small>
								<button type="submit" class="btn btn-primary">Send</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		const messageArea = document.getElementById("messageArea");
		const messageForm = document.getElementById("messageForm");
		const tokenUsage = document.getElementById("tokenUsage");
		const modelSelect = document.getElementById("modelSelect");
		const tempRange = document.getElementById("tempRange");
		const tempValue = document.getElementById("tempValue");

		function appendMessage(message) {
			const bubble = document.createElement("div");
			bubble.className = "bubble " + (message.role === "user" ? "user" : "assistant");
			const content = document.createElement("div");
			content.textContent = message.content;
			const meta = document.createElement("div");
			meta.className = "bubble-meta mt-1";
			meta.dataset.utc = message.createdAt;
			bubble.appendChild(content);
			bubble.appendChild(meta);
			messageArea.appendChild(bubble);
			updateLocalTimes();
			messageArea.scrollTop = messageArea.scrollHeight;
		}

		messageForm.addEventListener("submit", async (event) => {
			event.preventDefault();
			const formData = new FormData(messageForm);
			const content = formData.get("content");
			if (!content || !content.trim()) {
				return;
			}
			messageForm.querySelector("textarea").value = "";
			const response = await fetch("/api/chat/{{ .Chat.Summary.ID }}/message", {
				method: "POST",
				headers: { "Content-Type": "application/json", "Accept": "application/json" },
				body: JSON.stringify({
					content: content,
					model: modelSelect.value,
					temperature: tempRange.value
				})
			});
			if (!response.ok) {
				return;
			}
			const payload = await response.json();
			appendMessage(payload.user);
			appendMessage(payload.assistant);
			if (payload.usage) {
				tokenUsage.textContent = `Tokens: ${payload.usage.prompt_tokens} prompt / ${payload.usage.completion_tokens} completion / ${payload.usage.total_tokens} total`;
			}
		});

		tempRange.addEventListener("input", () => {
			tempValue.textContent = parseFloat(tempRange.value).toFixed(1);
		});

		messageArea.scrollTop = messageArea.scrollHeight;
	</script>
	{{ template "local_time.html" . }}
</body>
</html>
